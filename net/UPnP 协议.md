# UPnP 协议

## 定义

> UPNP（Universal Plug and Play）即通用即插即用协议，是为了实现电脑与智能的电器设备对等网络连接的体系结构。而内网地址与网络地址的转换就是基于此协议的，因此只要我们的路由器支持 upnp，并且我们使用支持此协议的 xp 操作系统，那么我们就可以借此提高点对点传输速度。

## 意义

在网络世界里，当一个主机加入网络时，其行为模式跟我们物理硬件的添加和删除设备是类似的。

在私有网络和公网交互的时候，私有网络中的主机使用的是内网 IP 地址，是无法被外网的主机直接访问的。必须借助 NAT 网关设备（本地路由器）把内网地址映射到网关的公网地址上。

当内网中的主机想要被外界主机直接访问（比如开放 80 端口，对外提供 HTTP 服务），我们就需要在 NAT 设备中为当前主机手工配置端口映射，如果内网中有多台主机都想要被外界主机直接访问的话，我们必须在同一个 NAT 设备上为这些主机分别做端口映射，它们之间不能使用有冲突的端口。

这个过程需要用户手工逐一配置，显然给用户带来了很大的麻烦。

另外，如果内部网络中有多个上网设备，每个设备上都有 Live Message 之类的软件需要在网关上开启一个端口进行数据传输，如果每次都使用一个固定端口的话，就会和其他用户冲突。

UPnP 技术标准的出现就是为了解决这个问题，只要 NAT 设备（路由器）支持 UPnP，并开启。那么，当我们的主机（或主机上的应用程序）向 NAT 设备发出端口映射请求的时候，NAT 设备就可以**自动**为主机分配端口并进行端口映射。

这样，我们的主机就能够像公网主机一样被网络中任何主机访问了。

## 协议体系

![2427147924](https://attacker.cc/usr/uploads/2018/12/2427147924.png)

## 工作流程

整个工作过程需要处理六个方面的内容，即地址分配、发现设备、对设备的描述、设备控制、设备事件、设备展示。

下面的图片对过程描述的很清楚。

![UPnP工作流程](https://attacker.cc/usr/uploads/2018/12/475878369.png)

### 1. 寻址（Addressing）

地址是整个 UPnP 系统工作的基础条件，每个设备都应当是 DHCP 的客户。

当设备首次与网络建立连接后，利用 DHCP 服务，使设备得到一个 IP 地址。这个 IP 地址可以是 DHCP 系统指定的，也可以是由设备选择的。

### 2. 发现（Discovery）

可分成两种情况：

- 在有控制请求之后，在当前的网络中查找有无对应的可用设备
- 某一设备接入网络、取得 IP 地址之后，就开始向网络 “广播” 自己已经进入网络，即寻找控制请求

### 3. 描述（Description）

简单说，这是声明 “自己” 是什么样的设备，例如名称、制造厂商、序列号码等等。

刚开始 “发现” 设备后，控制点对这个设备的 “了解” 还很少，需要依据 URL 找到该设备的描述文件，从这些文件中读取更多的描述信息。

![3284301250](https://attacker.cc/usr/uploads/2018/12/3284301250.png)

### 4. 控制（Control）

控制点找到设备描述之后，会从描述中 (即 XML 文件)“提炼” 出要进行的操作并获悉所有的服务。

对每个 UPnP 设备来说，这些描述必须是很确切、很详细的，描述中可能包含有命令或行为列表、服务响应信息、用到的参数等等。

对于服务的每个行为，也伴有描述信息：主要是整个服务进行期间的变量、变量的数据类型、可用的取值范围和事件的特征。

要控制某个设备，控制点必须先发送一个控制行为请求，要求设备开始服务，然后再按设备的 URL 发送相应的控制消息，控制消息就是放置在 SCPDXML 文件中的那些 SOAP 格式的信息。最后，服务会返回响应信息，指出服务是成功或是失败。

### 5. 事件（Eventing）

在服务进行的整个时间内，只要变量值发生了变化或者模式的状态发生了改变，就产生了一个事件，系统将修改上述提到的事件列表的内容。

随之，事件服务器把事件向整个网络进行广播。另一方面，控制点也可以事先向事件服务器**预约事件信息**，保证将该控制点感兴趣的事件及时准确地传送过来。

### 6. 展示（Presentation）

只要得到了设备的 URL，就可以取得该设备表达页面的 URL，然后可以将此表达 (展示) 纳入用户的本地浏览器上。

![483207321](https://attacker.cc/usr/uploads/2018/12/483207321.png)



------

[]: https://attacker.cc/index.php/archives/113/#menu_index_2	"UPnP 安全（二）：UPnP 协议具体流程"

