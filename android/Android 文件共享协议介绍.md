# Android 文件共享协议介绍

> `Android`平台上的文件管理器大多提供「文件共享」功能，采用主流共享协议有两种：`SMB`和`FTP`协议。
>
> 本文将介绍以下两种协议，并比较其与其他协议之间的优劣。

### 环境：
- `Android` & `Windows`
- `Android` & `macOS`

### 协议种类：
- `SMB`
- `FTP`
- `SFTP`

### SAMBA

#### 功能

`SAMBA`是一套使用`SMB/CIFS`协议的`Unix`应用程序，通过该套程序我们可以和`Windows`服务器共享资源。`SMB`协议采用了客户端-服务器端结构，使用「点对点」的通讯方式。

`SAMBA`服务提供这些功能：
- 分享档案与打印机服务；
- 可以提供用户登入`SAMBA`主机时的身份认证，以提供不同身份者的个别数据；
- 可以进行`Windows`网络上的主机名解析 (`NetBIOS name`)
- 可以进行装置的分享 (例如`Zip`, `CDROM`...)

`SAMBA`通过两个守护进程实现，分别是`smbd`和`nmbd`：
- `smbd`: 提供了`Samba`的大部分核心功能。包括提供文件和打印机共享，用户验证，提供时间服务。
  - `nmbd`：处理名称相关的任务，可以理解为`SAMBA`的域名系统（`DNS`）。功能包括对名称广播进行响应，注册`NetBIOS`名称，作为`NBNS`服务器运作，作为主浏览器运行。

#### 工作模式

`SAMBA`服务应用相当的广泛，而且可以依照不同的网域联机方式，与不同的用户账号密码的控管方式来进行分类。 例如最常见的`Workgroup` 及`Domain`两种方式的联机模式。最常见的局域网络的联机模式： `peer/peer` (对等模式) 及 `domain model` (主控模式)。

`peer/peer`:
简单的说，假如在局域网络里面的所有`PC`均可以在自己的计算机上面管理自己的账号与密码， 同时每一部计算机也都具有独力执行各项软件的能力，只是藉由网络将各个`PC`链接在一起而已的一个架构， 每台机器都是可以独立运转的。

`domain model`:
计算机资源需要账号与密码， 所有的账号与密码都可以放置在一部主控计算机(`PDC`)上面，在我的网域里面，任何人想要使用任何计算机时，都需要在屏幕前方输入账号与密码，然后通通藉由`PDC`服务器的辨识后，才给予适当的权限。也就是说，不同的身份还具有不一样的计算机资源权限就是了

#### 安全模式：

`SAMBA`服务器一共有四种不同的安全等级，在这些等级中，除了`share`等级外，其它三种等级都要求用户访问时输入正确的帐号以及密码，才能登陆并实用`SAMBA`服务器所共享的资源。
- `share`：若采用此等级，用户不需要输入帐号和密码即可登陆`SAMBA`服务器。
- `user`：这时`SAMBA`服务器默认的安全等级，检查帐号及密码的工作由提供服务的`samba`服务器负责。
- `server`：在此等级之下，检查帐号及密码的工作可指定另一台`WindowsNT/2000/XP`（通常为网域控制器）或`SAMBA`服务器负责。
- `domain`：在此等级之下，需要指定一台`WindowsNT/2000/XP`服务器，以严正用户所输入的帐号以及密码。

#### 协商流程：

![Alt text](../)

- 客户端向服务器请求一个`NETBIOS`会话，并且发送它的已编码的`NETBIOS`名字到`SMB`服务器(它们在`139`端口监听连接请求)。服务器接收到`NETBIOS`名字后回复一个`NETBIOS`会话数据报给有效的会话连接。客户端在建立了连接之后才能进入访问。
- 客户端发送一个`SMB negprot`请求数据报(`negprot`是磋商协议`negotiate protocol`的简写)。客户端列出了它所支持的所有`SMB`协议版本。

![Alt text](./img/second.gif)

- 通过磋商之后，客户端进程向服务器发起一个用户或共享的认证。
- 这个过程是通过发送`SesssetupX`(`SesssetupX`是会话建立和`Session setup and X`的简称)请求数据报实现的。客户端发送一对登录名/密码或一个简单密码到服务器，然后服务器通过发送一个`SesssetupX`应答数据报来允许或拒绝本次连接。

![Alt text](./img/third.gif)

- 在客户端完成了磋商和认证之后，它会发送一个`TconX`数据报并列出它想访问的特定网络资源的名称，之后服务器会发送一个`TconX`应答数据报以表示此次连接是否接受或拒绝。

### FTP

`FTP`协议是采用了`Client/Server`的架构，共享方作为`FTP`服务器，另一方则作为`FTP`客户端向服务器发送请求，访问共享文件。

#### 工作原理

`FTP`有两个过程一个是控制连接，一个是数据传输。`FTP`协议不像`HTTP`协议一样需要一个端口作为连接（默认时`HTTP`端口是`80`，`FTP`端口是`21`）。`FTP`协议需要两个端口，一个端口是作为控制连接端口，用于发送指令给服务器以及等待服务器响应；另外一个端口用于数据传输端，用于建立数据传输通道，主要作用是从的客户端向服务器发送文件，从服务器向客户端发送一个文件，从服务器向客户端发送文件或目录列表。

#### 连接模式

`PORT`（主动模式）
`FTP`客户端连接到`FTP`服务器的`21`端口，发送用户名和密码登录，登录成功后要`list`列表或者读取数据时，客户端随机开放一个端口，发送`PORT`命令到`FTP`服务器，告诉服务器客户端采用主动模式并开放端口；`FTP`服务器收到`PORT`主动模式命令和端口号后，通过服务器的`20`端口和客户端开放的端口连接，发送数据。

`PASV`（被动模式）
`FTP`客户端连接到`FTP`服务器的`21`端口，发送用户名和密码登录，登录成功后要`list`列表或者读取数据时，发送`PASV`命令到`FTP`服务器， 服务器在本地随机开放一个端口（`1024`以上），然后把开放的端口告诉客户端， 客户端再连接到服务器开放的端口进行数据传输。

以上工作模式可以总结为：
- 主动模式传送数据时是「服务器」连接到「客户端」的端口；被动模式传送数据是「客户端」连接到「服务端」的端口。
- 主动模式需要客户端必须开放端口给服务器，很多客户端都是在防火墙内，开放端口给`FTP`服务器访问比较困难。而被动模式只需要服务器端开放端口给客户端连接就行了。

### SFTP
`SFTP`与`FTP`之间的关系，可以和`HTTPS`与`HTTP`进行类比。`SFTP`与`FTP`有着几乎一样的语法和功能。`SFTP`为`SSH`的一部分，是一种传输档案至`Blogger`服务器的安全方式。

`SFTP`本身没有单独的守护进程，它必须使用`sshd`守护进程（端口号默认是`22`）来完成相应的连接操作，所以从某种意义上来说，`SFTP`并不像一个服务器程序，而更像是一个客户端程序。`SFTP`同样是使用加密传输认证信息和传输的数据，所以，使用`SFTP`是非常安全的。但是，由于这种传输方式使用了加密/解密技术，所以传输效率比普通的`FTP`要低得多，如果对网络安全性要求更高时，可以使用`SFTP`代替`FTP`。

### 比较：
- `SMB`协议与`FTP`协议最大的不同点，是`FTP`无法直接修改主机上面的档案数据，`SMB`可以修改。也就是说，若要存取一个文件，就必须先获得一个本地的文件副本。如果要修改文件，只能对文件的副本进行修改，然后再将修改后的文件传回到原节点。
- `SMB`协议主要是为了解决`Linux`系统和`Windows`系统之间的文件共享。`Windows PC`和`Android`端共享没有问题，但是由于`macOS`上有自己独特的`SMB`协议，所以不能直接使用原生`SMB`协议进行共享，也就是说`Mac`平台上需要第三方软件才可以实现`SMB`协议的文件共享。相反，`FTP`协议则没有这样的约束，通用性较强。
- 传输速度上，相同配置环境，`FTP`协议传输单个大文件时候会比较有优势，`SMB`协议在传输大量小文件时候较有优势。

### 总结：
- `Android` & `Windows`: 使用`SMB`协议
- `Android` & `macOS`: 使用第三方 `SMB` 协议或 `SFTP`协议

---

参考资料：
> https://blog.csdn.net/xbgprogrammer/article/details/43304321
> https://www.samba.org/cifs/docs/what-is-smb.html
> https://blog.csdn.net/shmilychan/article/details/51848850
